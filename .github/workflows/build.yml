name: Build Static Nginx (Final Fix)

on:
  workflow_dispatch:

env:
  NGINX_VERSION: "1.28.1"
  OPENSSL_VERSION: "3.0.15"
  PCRE2_VERSION: "10.42"
  ZLIB_VERSION: "1.3.1"

jobs:
  build-static:
    name: Build Nginx ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Static Build in CentOS 7
        run: |
          docker run --rm --platform linux/${{ matrix.arch }} \
            -v ${{ github.workspace }}:/workspace \
            -e NGINX_VERSION=${{ env.NGINX_VERSION }} \
            -e OPENSSL_VERSION=${{ env.OPENSSL_VERSION }} \
            -e PCRE2_VERSION=${{ env.PCRE2_VERSION }} \
            -e ZLIB_VERSION=${{ env.ZLIB_VERSION }} \
            centos:7 /bin/bash -c "
              # 1. 环境准备：禁用 GPG 并安装必备包
              sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
              sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
              yum install -y --nogpgcheck gcc gcc-c++ make wget perl-core perl-IPC-Cmd glibc-static zlib-devel pcre-devel
              
              # 2. 下载依赖源码
              cd /tmp
              wget -q --no-check-certificate https://www.openssl.org/source/openssl-\${OPENSSL_VERSION}.tar.gz && tar -zxf openssl-\${OPENSSL_VERSION}.tar.gz
              wget -q --no-check-certificate https://github.com/PCRE2Project/pcre2/releases/download/pcre2-\${PCRE2_VERSION}/pcre2-\${PCRE2_VERSION}.tar.gz && tar -zxf pcre2-\${PCRE2_VERSION}.tar.gz
              wget -q --no-check-certificate https://zlib.net/zlib-\${ZLIB_VERSION}.tar.gz && tar -zxf zlib-\${ZLIB_VERSION}.tar.gz
              
              # 3. 下载并解压 Nginx
              wget -q --no-check-certificate http://nginx.org/download/nginx-\${NGINX_VERSION}.tar.gz && tar -zxf nginx-\${NGINX_VERSION}.tar.gz
              cd nginx-\${NGINX_VERSION}

              # 4. 执行配置
              # 注意：我们去掉了 --with-ld-opt='-static'，改用更温和的方式
              ./configure --prefix=/usr/local/nginx \
                  --with-http_ssl_module \
                  --with-http_v2_module \
                  --with-http_realip_module \
                  --with-http_stub_status_module \
                  --with-http_gzip_static_module \
                  --with-stream \
                  --with-stream_ssl_module \
                  --with-stream_realip_module \
                  --with-openssl=/tmp/openssl-\${OPENSSL_VERSION} \
                  --with-pcre=/tmp/pcre2-\${PCRE2_VERSION} \
                  --with-zlib=/tmp/zlib-\${ZLIB_VERSION} \
                  --with-cc-opt='-O3'

              # 5. 关键步骤：在编译链接时强制指定静态链接
              # 我们通过修改 objs/Makefile 或者直接在 make 命令行注入
              make -j\$(nproc) CORE_LIBS='-static -lpthread -ldl -lrt'
              
              # 6. 整理产物
              mkdir -p /workspace/dist
              cp objs/nginx /workspace/dist/nginx-\${NGINX_VERSION}-static-${{ matrix.arch }}
            "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ env.NGINX_VERSION }}-${{ matrix.arch }}
          path: dist/nginx-${{ env.NGINX_VERSION }}-static-${{ matrix.arch }}